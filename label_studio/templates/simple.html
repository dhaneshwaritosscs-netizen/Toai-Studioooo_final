{% load static %}
{% load i18n %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content=""/>
  <meta name="viewport" content="width=device-width, initial-scale=0.9, shrink-to-fit=no">

  <!-- Address string color -->
  <meta name="theme-color" content="#272727"> <!-- Chrome, Firefox OS and Opera -->
  <meta name="msapplication-navbutton-color" content="#272727">  <!-- Windows Phone -->
  <meta name="apple-mobile-web-app-status-bar-style" content="#272727">  <!-- iOS Safari -->

  <link href="{{settings.HOSTNAME}}{% static 'css/main.css' %}" rel="stylesheet"/>
  {% block app-css %}
    <link href="{{settings.FRONTEND_HOSTNAME}}/react-app/main.css?v={{ versions.backend.commit }}" rel="stylesheet">
  {% endblock %}


  {% block page_labeling %}
    <title>TOAI Studio</title>
    <link rel="icon" type="image/x-icon" href="{{settings.HOSTNAME}}{% static 'images/favicon.ico' %}?v=3">
    <link rel="shortcut icon" type="image/x-icon" href="{{settings.HOSTNAME}}{% static 'images/favicon.ico' %}?v=3">
    <link rel="icon" type="image/png" sizes="32x32" href="{{settings.HOSTNAME}}{% static 'images/favicon.png' %}?v=3">
    <link rel="icon" type="image/png" sizes="64x64" href="{{settings.HOSTNAME}}{% static 'images/icon.png' %}?v=3">
    <link rel="apple-touch-icon" sizes="180x180" href="{{settings.HOSTNAME}}{% static 'images/icon.png' %}?v=3">
  {% endblock %}

  {% block head %}
  {% endblock %}

  {% block theme_colors %}
    <script>
      function handleThemeColor() {
        let themeColor = window.localStorage.getItem("preferred-color-scheme");
        if (themeColor === "Auto") {
          themeColor = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "Dark" : "Light"
        } else if (!themeColor) {
          themeColor = "Light";
        }
        document.documentElement.setAttribute("data-color-scheme", themeColor.toLowerCase());
      }
      handleThemeColor();
    </script>
  {% endblock %}

  <!-- Load jQuery FIRST - Synchronous loading -->
  <script>
    // Force synchronous jQuery loading using document.write
    document.write('<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"><\/script>');
  </script>
  <script>
    // Verify jQuery is loaded and make it globally available
    if (typeof jQuery === 'undefined') {
      console.error('jQuery failed to load');
      // Try fallback
      document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"><\/script>');
    } else {
      console.log('jQuery loaded successfully');
      // Make sure jQuery is available globally
      window.jQuery = window.$ = jQuery;
    }
  </script>

</head>

<body>
{% block content %}
{% endblock %}

{% block bottomjs %}
  <script nonce="{{request.csp_nonce}}">
    // CSRF - Ensure jQuery is available
    (function() {
      // Wait for jQuery to be available
      function waitForJQuery(callback, maxAttempts) {
        maxAttempts = maxAttempts || 50; // 5 seconds max wait
        var attempts = 0;
        
        function check() {
          attempts++;
          if (typeof jQuery !== 'undefined' && typeof $ !== 'undefined') {
            callback();
          } else if (attempts < maxAttempts) {
            setTimeout(check, 100);
          } else {
            console.error('jQuery not available after maximum attempts');
          }
        }
        
        check();
      }
      
      waitForJQuery(function() {
        console.log('jQuery is available, setting up CSRF');
        
        function csrfSafeMethod(method) {
          // these HTTP methods do not require CSRF protection
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        // Apply CSRF token
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
        if (csrftoken) {
          $.ajaxSetup({
            beforeSend: function (xhr, settings) {
              if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
              }
            }
          });
          console.log('CSRF token setup completed');
        } else {
          console.warn('CSRF token not found');
        }
      });
    })();
  </script>
{% endblock %}

</body>
</html>
